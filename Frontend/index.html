<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Solaris Dictation</title>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; color: #1a202c; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 950px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h1 { margin: 0; font-size: 24px; color: #2d3748; }
        .tag { background: #ebf8ff; color: #2b6cb0; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }

        .controls { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; background: #f7fafc; padding: 15px; border-radius: 8px; }
        
        button { padding: 12px 24px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        #startBtn { background-color: #e53e3e; color: white; box-shadow: 0 4px 6px rgba(229, 62, 62, 0.3); }
        #startBtn:hover { transform: translateY(-1px); }
        #startBtn.recording { background-color: #2d3748; box-shadow: none; }
        
        select { padding: 12px; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 16px; outline: none; }
        
        .status { font-weight: bold; color: #a0aec0; margin-left: auto; }
        .status.live { color: #38a169; animation: pulse 2s infinite; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .box { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; min-height: 250px; display: flex; flex-direction: column; }
        .box h3 { margin: 0 0 15px 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: #718096; border-bottom: 2px solid #edf2f7; padding-bottom: 10px; }
        .content { font-size: 18px; line-height: 1.6; color: #4a5568; white-space: pre-wrap; flex-grow: 1; }
        
        .clean-box { background: #f0fff4; border-color: #c6f6d5; }
        .clean-box .content { color: #22543d; font-weight: 500; }

        #logs { margin-top: 25px; font-family: 'Consolas', monospace; font-size: 12px; color: #718096; border-top: 1px solid #e2e8f0; padding-top: 15px; }
        .log-item { margin-bottom: 5px; display: flex; align-items: center; }
        .latency-badge { background: #edf2f7; color: #4a5568; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 10px; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>‚ö° Solaris Dictation</h1>
        <span class="tag">Problem Statement 4</span>
    </div>

    <div class="controls">
        <select id="toneSelect">
            <option value="Neutral">Mode: Neutral</option>
            <option value="Formal">Mode: Formal (Professional)</option>
            <option value="Casual">Mode: Casual (Lowercase)</option>
            <option value="Concise">Mode: Concise (No Fluff)</option>
        </select>
        
        <button id="startBtn" onclick="toggleMic()">üéôÔ∏è Start Recording</button>
        <div id="status" class="status">üî¥ Offline</div>
    </div>

    <div class="grid">
        <div class="box">
            <h3>üó£Ô∏è Raw Input (Including Fillers)</h3>
            <div id="rawText" class="content">...</div>
        </div>
        <div class="box clean-box">
            <h3>‚ú® Final Output (Cleaned)</h3>
            <div id="cleanText" class="content">...</div>
        </div>
    </div>

    <div id="logs">
        <div>Latency Metrics will appear here...</div>
    </div>
</div>

<script>
    let socket;
    let audioContext;
    let processor;
    let input;
    let globalStream;
    let isRecording = false;

    function toggleMic() {
        if (!isRecording) start();
        else stop();
    }

    async function start() {
        const tone = document.getElementById("toneSelect").value;
        const btn = document.getElementById("startBtn");
        const status = document.getElementById("status");

        try {
            // 1. Initialize Audio to get Rate
            globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new AudioContext(); 
            const sampleRate = audioContext.sampleRate;
            
            // 2. Open WebSocket
            socket = new WebSocket("ws://" + location.host + "/ws?mode=" + tone + "&rate=" + sampleRate);
            
            socket.onopen = async () => {
                status.innerText = "üü¢ Live & Listening (" + sampleRate + "Hz)";
                status.classList.add("live");
                btn.innerText = "üõë Finish & Process";
                btn.classList.add("recording");
                document.getElementById("toneSelect").disabled = true;

                // 3. Connect Stream
                input = audioContext.createMediaStreamSource(globalStream);
                processor = audioContext.createScriptProcessor(2048, 1, 1);
                
                processor.onaudioprocess = (e) => {
                    if (socket.readyState === WebSocket.OPEN) {
                        const float32Data = e.inputBuffer.getChannelData(0);
                        socket.send(float32Data);
                    }
                };

                input.connect(processor);
                processor.connect(audioContext.destination);
                isRecording = true;
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === "result") {
                    // Append Raw (So we see history including fillers)
                    const rawBox = document.getElementById("rawText");
                    const currentRaw = rawBox.innerText === "..." ? "" : rawBox.innerText;
                    rawBox.innerText = currentRaw + " " + data.raw;
                    
                    // Append Clean
                    const cleanBox = document.getElementById("cleanText");
                    const currentClean = cleanBox.innerText === "..." ? "" : cleanBox.innerText;
                    cleanBox.innerText = currentClean + " " + data.clean;
                    
                    // Log
                    const logs = document.getElementById("logs");
                    const logHTML = `
                        <div class="log-item">
                            <span class="latency-badge">${data.latency}ms</span>
                            <span>[${data.breakdown}]</span>
                        </div>`;
                    logs.innerHTML = logHTML + logs.innerHTML;
                }
            };

            socket.onclose = () => {
                resetUI();
            };

        } catch (err) {
            alert("Microphone Error: " + err);
            console.error(err);
        }
    }

    function stop() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            // Send STOP command to server to process remaining buffer
            socket.send("STOP");
            // The server will close the connection after sending the last result
        } else {
            resetUI();
        }
    }

    function resetUI() {
        if (globalStream) globalStream.getTracks().forEach(track => track.stop());
        if (audioContext) audioContext.close();
        
        isRecording = false;
        document.getElementById("status").innerText = "üî¥ Offline";
        document.getElementById("status").classList.remove("live");
        document.getElementById("startBtn").innerText = "üéôÔ∏è Start Recording";
        document.getElementById("startBtn").classList.remove("recording");
        document.getElementById("toneSelect").disabled = false;
    }
</script>

</body>
</html>